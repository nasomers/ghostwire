// MalwareBazaar (abuse.ch) - Malware Sample Repository
// Actual malware samples being distributed in the wild

export interface MalwareSample {
  id: string;
  timestamp: string;
  sha256: string;
  sha1: string;
  md5: string;
  filename: string;
  fileType: string;
  fileSize: number;
  signature: string;
  tags: string[];
  reporter: string;
  deliveryMethod: string;
  country?: string;
}

export interface MalwareBazaarCallbacks {
  onSample: (sample: MalwareSample) => void;
  onError: (error: Error) => void;
}

export class MalwareBazaarClient {
  private callbacks: MalwareBazaarCallbacks;
  private pollInterval: Timer | null = null;
  private seenHashes = new Set<string>();
  private pollIntervalMs = 120000; // 2 minutes

  constructor(callbacks: MalwareBazaarCallbacks) {
    this.callbacks = callbacks;
  }

  async start() {
    console.log('[MalwareBazaar] Starting malware sample feed...');
    await this.poll();
    this.pollInterval = setInterval(() => this.poll(), this.pollIntervalMs);
  }

  stop() {
    if (this.pollInterval) {
      clearInterval(this.pollInterval);
      this.pollInterval = null;
    }
  }

  private async poll() {
    try {
      // MalwareBazaar API - recent samples
      const response = await fetch('https://mb-api.abuse.ch/api/v1/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'query=get_recent&selector=time'
      });

      if (!response.ok) {
        console.log('[MalwareBazaar] API returned ' + response.status + ', using simulated data');
        this.emitSimulated();
        return;
      }

      const result = await response.json();
      if (result.query_status !== 'ok' || !result.data) {
        this.emitSimulated();
        return;
      }

      let newCount = 0;
      const maxNew = 10;

      for (const entry of result.data) {
        if (newCount >= maxNew) break;

        const hash = entry.sha256_hash;
        if (!hash || this.seenHashes.has(hash)) continue;

        const sample: MalwareSample = {
          id: `mb-${hash.slice(0, 16)}`,
          timestamp: new Date().toISOString(),
          sha256: hash,
          sha1: entry.sha1_hash || '',
          md5: entry.md5_hash || '',
          filename: entry.file_name || 'unknown',
          fileType: entry.file_type || entry.file_type_mime || 'unknown',
          fileSize: entry.file_size || 0,
          signature: entry.signature || 'unknown',
          tags: entry.tags || [],
          reporter: entry.reporter || 'anonymous',
          deliveryMethod: this.guessDeliveryMethod(entry)
        };

        this.callbacks.onSample(sample);
        this.seenHashes.add(hash);
        newCount++;
      }

      // Limit memory
      if (this.seenHashes.size > 3000) {
        const arr = Array.from(this.seenHashes);
        this.seenHashes = new Set(arr.slice(-1500));
      }

      if (newCount > 0) {
        console.log(`[MalwareBazaar] ${newCount} new malware samples`);
      }
    } catch (err) {
      console.error('[MalwareBazaar] Poll error:', err);
      this.emitSimulated();
    }
  }

  private guessDeliveryMethod(entry: any): string {
    const filename = (entry.file_name || '').toLowerCase();
    const tags = (entry.tags || []).map((t: string) => t.toLowerCase());

    if (tags.includes('email') || filename.includes('invoice') || filename.includes('receipt')) return 'phishing_email';
    if (filename.endsWith('.js') || filename.endsWith('.vbs') || filename.endsWith('.ps1')) return 'script_dropper';
    if (filename.endsWith('.doc') || filename.endsWith('.docm') || filename.endsWith('.xlsm')) return 'macro_document';
    if (filename.endsWith('.iso') || filename.endsWith('.img')) return 'disk_image';
    if (filename.endsWith('.lnk')) return 'malicious_shortcut';
    if (tags.includes('exploit')) return 'exploit_kit';
    if (tags.includes('drive-by')) return 'drive_by_download';

    return 'direct_download';
  }

  private emitSimulated() {
    const signatures = ['Emotet', 'QakBot', 'IcedID', 'RedLine', 'Raccoon', 'AgentTesla', 'AsyncRAT', 'Remcos', 'FormBook', 'Lokibot'];
    const fileTypes = ['exe', 'dll', 'doc', 'xls', 'js', 'ps1', 'iso', 'zip'];
    const deliveries = ['phishing_email', 'script_dropper', 'macro_document', 'exploit_kit', 'direct_download'];

    const count = 2 + Math.floor(Math.random() * 4);
    for (let i = 0; i < count; i++) {
      const fileType = fileTypes[Math.floor(Math.random() * fileTypes.length)];
      const sample: MalwareSample = {
        id: `mb-sim-${Date.now()}-${i}`,
        timestamp: new Date().toISOString(),
        sha256: this.randomHex(64),
        sha1: this.randomHex(40),
        md5: this.randomHex(32),
        filename: `${this.randomFilename()}.${fileType}`,
        fileType,
        fileSize: 10000 + Math.floor(Math.random() * 500000),
        signature: signatures[Math.floor(Math.random() * signatures.length)],
        tags: ['malware'],
        reporter: 'simulated',
        deliveryMethod: deliveries[Math.floor(Math.random() * deliveries.length)]
      };
      this.callbacks.onSample(sample);
    }
  }

  private randomHex(len: number): string {
    const chars = '0123456789abcdef';
    return Array.from({ length: len }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
  }

  private randomFilename(): string {
    const prefixes = ['invoice', 'document', 'receipt', 'payment', 'order', 'report', 'scan', 'update', 'setup'];
    const suffixes = ['_2024', '_final', '_v2', '_new', '_updated', ''];
    return `${prefixes[Math.floor(Math.random() * prefixes.length)]}${suffixes[Math.floor(Math.random() * suffixes.length)]}`;
  }
}
